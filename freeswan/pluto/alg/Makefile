# pluto/alg Makefile
# Author: JuanJo Ciarlante <jjo-ipsec@mendoza.gov.ar>
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.  See <http://www.fsf.org/copyleft/gpl.txt>.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
# or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
# for more details.
#
# $Id: Makefile,v 1.1 2002/07/15 05:50:34 danield Exp $

Make.common: ../Makefile
	make -s -C .. showdefs > $@

-include Make.common

LIBCRYPTO:=../../libcrypto
# ALLFLAGS=$(CPPFLAGS) $(CFLAGS) -I .. -I-  -I ../../lib -I ../../libcrypto
ALLFLAGS=$(CPPFLAGS) $(CFLAGS) -I.. -I../../lib -I../../libcrypto
LIBALG := libalg.o

all : $(LIBALG)

include $(wildcard Makefile.ike_alg_*)
#include $(wildcard Makefile.ike_alg_[ab]*)

$(LIBALG): ike_alginit.o $(ALG_OBJS) $(ALG_LIBS)
	$(LD) -r -o $@ $^

# Search for IKE_ALG_INIT_NAME: in ike_alg_*.c to
# build ike_alginit.c:ike_alginit()

ike_alginit.c: $(ALG_SRCS) Makefile
	@awk '	\
		BEGIN { print "extern int ike_alg_init(void); \
			int ike_alg_init(void) {" } \
		/IKE_ALG_INIT_NAME:/ \
			{ print "{ extern int " $$2" (void); " $$2 "();}" } \
		END   { print "return 0;}" } \
		' $(ROOTDIR)/freeswan/pluto/alg/ike_alg_aes.c /dev/null > $@ 

clean :
	@for i in $(ALG_DIRS);do make -C $$i clean;done
	rm -f *.[oa] ike_alginit.c Make.common

gatherdeps:
	@ls $(ALG_SRCS) | grep '\.c' | sed -e 's/\(.*\)\.c$$/\1.o: \1.c/'
	@echo
	@ls $(ALG_SRCS) | grep '\.c' | xargs grep '^#[ 	]*include[ 	]*"' | \
		sed -n -e '/#include.*"lib/d' \
		-e 's/\.c:#[ 	]*include[ 	]*"/.o: ..\//' -e 's/".*//p'

# Dependencies generated by "make gatherdeps":

ike_alg_aes.o: ike_alg_aes.c
ike_alg_blowfish.o: ike_alg_blowfish.c
ike_alg_cast.o: ike_alg_cast.c
ike_alg_sha2.o: ike_alg_sha2.c

ike_alg_aes.o: ../md5.h
ike_alg_aes.o: ../sha1.h
ike_alg_aes.o: ../constants.h
ike_alg_aes.o: ../defs.h
ike_alg_aes.o: ../state.h
ike_alg_aes.o: ../log.h
ike_alg_aes.o: ../crypto.h
ike_alg_aes.o: ../alg_info.h
ike_alg_aes.o: ../ike_alg.h
ike_alg_blowfish.o: ../md5.h
ike_alg_blowfish.o: ../sha1.h
ike_alg_blowfish.o: ../constants.h
ike_alg_blowfish.o: ../defs.h
ike_alg_blowfish.o: ../state.h
ike_alg_blowfish.o: ../log.h
ike_alg_blowfish.o: ../crypto.h
ike_alg_blowfish.o: ../alg_info.h
ike_alg_blowfish.o: ../ike_alg.h
ike_alg_cast.o: ../md5.h
ike_alg_cast.o: ../sha1.h
ike_alg_cast.o: ../constants.h
ike_alg_cast.o: ../defs.h
ike_alg_cast.o: ../state.h
ike_alg_cast.o: ../log.h
ike_alg_cast.o: ../crypto.h
ike_alg_cast.o: ../alg_info.h
ike_alg_cast.o: ../ike_alg.h
ike_alg_sha2.o: ../md5.h
ike_alg_sha2.o: ../sha1.h
ike_alg_sha2.o: ../constants.h
ike_alg_sha2.o: ../defs.h
ike_alg_sha2.o: ../state.h
ike_alg_sha2.o: ../log.h
ike_alg_sha2.o: ../crypto.h
ike_alg_sha2.o: ../alg_info.h
ike_alg_sha2.o: ../ike_alg.h
